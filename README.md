# Python-project description

This Python program use API from MITMPROXY and Appium to mimic finger scroll on cell phone screen, grab the data(.mp4) of an cell phone app and save the video files on computer with correct name based on JSON data of other Http response for this app.<br /><br />

TikTok is a popular app where you can find lots of interest videos. By analyze its url flow using Mitmproxy, I find that it loads videos in a "set" (normally 8 videos). Everytime before it loads videos, it resquest JSON data which contains detailed information of next "set" of videos. The following videos come in an order from 1st to the 8th in JSON file. So we can name the vidoes according to its order. This is the first version of the program. But there are bugs in naming video because for each videos, the server will send multiple same videos with different encrypted URLs which results duplicate and error naming.<br /><br />

The 2nd version of the program use a list to contain all a content-length of videos because the same videos comes from different servers have the same content-length. And we cannot use the other properties such as video duration or ETag becuase it's either inaccurate or unstable (some servers don't send headers with ETag). But there is still bugs. Because due to network latency, current set of videos are not always come in the order that shows in current JSON. Occasionaly, the content-length of same videos maybe different, also, in a rare case, there are some videos which are not support to be displayed (no information in JSON) but servers just send them. Maybe TikTok try to prevent people like me to crawle it :D <br /><br />

So the 3rd version solve all that. By analyzing the video files, I find that all video files saved in Windows computer have a "comments" properties. Which stores a unique "vid", and this vid can be find in JSON, so we can use it to match vid and name the video currently and we don't have to worry about the order of videos plus some uninvited videos.
I use a double anti-duplicate method to filter duplicate videos:1. use content-length method first so it's efficient because program won't download videos that has already been downloaded. 2. after download file, read it's "vid", if it matches the data in JSON, we rename it, otherwise we delete it.


# Installation
### Environment: 
- Windows<br />
- Python<br />
- Visual C++ Complier <br />
- Node.js<br />
- Java SE Development Kit 8<br />
- Android Studio (if you know which version of your Android JDK is, you can download the **Command line tools** directly from [here](https://developer.android.com/studio/#downloads))<br />
- Mitmproxy<br />
- FFmpeg (for getting Metadata of files)<br />
- Appium<br />
- An Android cellphone (or an Android emulator) enabled USB debug and Installed certificate generated by Mitmproxy<br />
- The TikTok (android app) installed on android phone<br />
- An USB cable connect android phone to the working computer<br /><br />

:point_right:**Python**<br />
  - Download Python from [Here](https://www.python.org/downloads/release/python-370/)<br />
  - [Click this Youtube Tutorial](https://www.youtube.com/watch?v=YYXdXT2l-Gg) for installation video and how to run a python program on Mac and Windows<br />
  - To check if you have successfully installed Python, open Command Prompt and enter "Python"(no double quotes), if you see Python version, that is a success installation<br />
  - Also enter "pip -v"(no double quotes) to see if you can see commands and options for pip<br />
  - install requests module, in the command prompt, enter "pip install requests"(no double quotes)<br /><br />
  
:point_right:**Visual C++ Complier**<br />
  - Click this [Link](https://www.scivision.co/python-windows-visual-c++-14-required/) to see instruction
  - After step3 of the link, restart your computer<br /><br />
  
:point_right:**Node.js**<br />
  - Download Node.js [Here](https://nodejs.org/en/download/)
  - There is a download and installation video available (**Watch first 5 mins**) [Here](https://www.youtube.com/watch?v=gHuIKptS0Qg)
  - To check if you have successfully installed Node, open Command Prompt and enter "node -v" and "npm -v"(no double quotes), if you see  version information, that is a success installation<br /><br />

:point_right:**Java SE Development Kit 8**<br />
  - Download and Install JDK8 [Here](http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html)
  - Remember the Installation Path for later use<br /><br />

:point_right:**Android Studio**<br />
  - Download and install Android Studio [Here](https://developer.android.com/studio/)
  - Watch [this video](https://www.youtube.com/watch?v=7vvMltQtfxY) for installation (**only upto 1:40**)
  - After installation, open Android Studio, if it's the first time you run it, click create a new project, click next multiple times until you see the main program interface
  - At the top-right corner, find and open SDK manager (icon with a downward arrow)
  - At the top of the popup window, remember the Android SDK Location (for later use)
  - At the SDK Platforms tab, check from Android 8.1 to Android 5.0 (Generally your phone won't be older than 5.0 version)
  - At the SDK tools tab, check Android SDK Build-Tools, Android SDK Platform-Tools, Android SDK Tools, Google USB Driver, Google Web Driver and click apply to download and install these parts<br /><br />
  

:point_right:**Mitmproxy**<br />
  - Download Mitmproxy from [Here](https://mitmproxy.org/)
  - Install Mitmproxy from file
  - To check if you have successfully installed Mitmproxy, open Command Prompt and enter "mitmdump"(no double quotes), if you see a message "*Proxy server listening at http://\*:8080*", that is a success installation
  - open command prompt, enter "pip install mitmproxy"(no double quotes) <br /><br />

:point_right:**FFmpeg**<br />
  - Download FFmpeg from [Here](https://www.ffmpeg.org/download.html), choose **Version** for distributors (move your mouse on to see discription), **Windows** platform and **Static** Linking
  - Install FFmpeg like this [Video](https://www.youtube.com/watch?v=pHR3ttH5t-w). Only watch first **2mins**, remember to check if successfully installed like what's in the video <br /><br />
  
:point_right:**Appium**
<br />
  - Download and install Appium from [Here](https://github.com/appium/appium-desktop/releases/tag/1.7.0)
  - open Command Prompt and enter "pip install Appium-Python-Client"(no double quotes) to install Appium library for Python
  - watch this [video](https://www.youtube.com/watch?v=-GJTzPOIoqs&t=178s) for installation (from 1:54 to 2:56, and from 4:38 to 5:52). Note the paths of JAVA and ANDROID-SDK would be applied here during installation.
  - install appium-doctor, open command window, enter "npm install appium-doctor -g"(no double quote)
  - in the Command Prompt, enter "appium-doctor" to check if all prerequisite are installed for Appium. If you see a result that the Android_Home/Java_Home path is not set, set the path following this video [Here](https://www.youtube.com/watch?v=Y6LT5lgOj0Y). Note that if you do the above step and JAVA_HOME is still not set, just restart it, then it will be showed as set. <br /><br />
  
:point_right:**Android cellphone Setting**<br />
  ##### enabled USB debug 
  - Find instruction [Here](https://www.embarcadero.com/starthere/xe7/mobdevsetup/android/en/enabling_usb_debugging_on_an_android_device.html)
 
  ##### Installed certificate generated by Mitmproxy
  - Download and unzip **certificate.zip** in this repository
  - Transfer the unzipped files into your Android Phone and remember the location
  - Find **Install certificates** option from your Android phone settings
  - Navigate to the location where you save the files, install both certificate files on your Android phone, choose the VPN and app options (not WLAN/WiFi)
  ##### Phone setting
  - find your IPv4 address, if your computer use wifi connection, see [This](https://www.youtube.com/watch?v=PZtbGoTaN3E); if your computer use cable connection, see [This](https://www.youtube.com/watch?v=6wqxd5Eo0QA). Hint, you can choose to reserve your IP address on the router so it reminds the same in your LAN.
  - open your phone Wifi setting, open **current** wifi's extra setting, set Proxy as mannual,  enter your computer's IPv4 address that you just recorded. Enter 8080 as Port.
  
  <br /><br />

:point_right:**Install TikTok on you Android system/phone**<br /><br /><br /><br />

  
# How to run the Python program
#### Connect your phone to your computer by cable
#### Download and unzip the zip file (download code for Chinese or English version)
#### Upgrade your app to the newest version
#### Open appium software and click start server v1.8.1 (default setting: simple:HOST-0.0.0.0,PORT-4723)
#### Open Command Prompt and navigate working directory to the unzipped folder
#### Enter command "mitmdump -s run.py" (no double quotes)
#### Find the growing videos files in video folder<br /><br />

  
 # More information

 
 Welcome any feedback and comments.
